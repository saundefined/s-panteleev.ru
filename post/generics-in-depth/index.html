<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Погружаемся в дженерики | Сергей Пантелеев</title>
    <meta name="description" content="Перевод серии статей о дженериках в PHP. Часть 2.">
            <link rel="alternate" hreflang="en" href="https://stitcher.io/blog/generics-in-php-2"/>
            <!-- Yandex.Metrika counter -->
        <script type="text/javascript"> (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () {(m[i].a = m[i].a || []).push(arguments)}
            m[i].l = 1 * new Date()
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(
              k, a)
          })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym')
          ym(50044507, 'init',
            { clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true }) </script>
        <noscript>
            <div><img src="https://mc.yandex.ru/watch/50044507" style="position:absolute; left:-9999px;" alt=""/></div>
        </noscript> <!-- /Yandex.Metrika counter -->
        <link rel="stylesheet" href="/assets/build/css/main.css">
</head>
<body class="flex flex-col justify-between min-h-screen font-sans antialiased">
<nav aria-labelledby="nav-heading" :aria-expanded="isOpen"
     class="container flex flex-wrap items-center justify-between py-5" x-data="{ isOpen: false }"
     @keydown.escape="isOpen = false" @click.away="isOpen = false">
    <a aria-label="logo" href="https://s-panteleev.ru">
        <span class="font-bold text-xl lg:text-lg text-dark-purplish-blue">Сергей Пантелеев</span>
    </a>

    <button :aria-expanded="isOpen" aria-controls="nav-list" aria-label="toggle menu" @click="isOpen = !isOpen"
            type="button" class="block px-2 text-indigo-900 lg:hidden focus:outline-none">
        <svg class="w-8 h-8 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path x-show.transition="!isOpen"
                  d="M3 7h18a1 1 0 100-2H3a1 1 0 000 2zm18 10H3a1 1 0 000 2h18a1 1 0 000-2zm0-4H3a1 1 0 000 2h18a1 1 0 000-2zm0-4H3a1 1 0 000 2h18a1 1 0 000-2z"/>

            <path x-show="isOpen"
                  d="M13.41 12l6.3-6.29a1.004 1.004 0 00-1.42-1.42L12 10.59l-6.29-6.3a1.004 1.004 0 10-1.42 1.42l6.3 6.29-6.3 6.29a.999.999 0 000 1.42 1 1 0 001.42 0l6.29-6.3 6.29 6.3a1.001 1.001 0 001.639-.325 1 1 0 00-.22-1.095L13.41 12z"/>
        </svg>
    </button>

    <!--Menu-->
    <div class="flex-grow w-full lg:flex lg:items-center lg:w-auto hidden"
         :class="{ 'block': isOpen, 'hidden': !isOpen }">
        <ul id="nav-list"
            class="flex-wrap items-center justify-end flex-1 pt-6 space-y-5 lg:space-y-0 lg:pt-0 list-reset lg:flex lg:space-x-10">
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/">Главная</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/posts/">Статьи</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/projects/">Проекты</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/about/">Обо мне</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container">
        <div class="container pb-16 md:pb-28">
        <div class="pt-8 md:pt-16 pb-4 md:pb-8">
            <h1 class="font-bold xl:text-6xl lg:text-5xl md:text-4xl text-3xl text-dark-purplish-blue text-center">
                Погружаемся в дженерики
            </h1>

            <div class="flex flex-row items-center my-8 space-x-1 md:space-x-4 justify-center">
                                                            <a href="/posts/tag/php"
       class="bg-dark-purplish-blue text-white px-2 py-1 rounded uppercase text-sm font-bold">PHP</a>
                                            <a href="/posts/tag/generics"
       class="bg-dark-purplish-blue text-white px-2 py-1 rounded uppercase text-sm font-bold">Дженерики в PHP</a>
                                    
                <p class="font-normal text-base text-gray-600">1 апреля 2022 г.</p>
            </div>
        </div>

        <div class="h-64 md:h-96 mb-8">
            <img class="object-contain w-full h-full bg-dark-purplish-blue"
                 style="object-position: 50% 50%"
                 src="/assets/images/posts/generics-in-depth/cover.jpg"
                 alt="Погружаемся в дженерики">
        </div>

        <div class="max-w-4xl">
                            <div class="w-full bg-gray-100 my-5 text-dark-purplish-blue">
                    <div class="container flex items-center justify-between px-6 py-4 mx-auto">
                        <div class="flex">
                            <span class="font-medium mr-1">Перевод статьи</span>
                            «<a href="https://stitcher.io/blog/generics-in-php-2"
                                rel="noreferrer noopener"
                                class="display-inline border-b border-gray-300 hover:border-transparent transition-all"
                                target="_blank">Generics in depth</a>»
                        </div>
                    </div>
                </div>
            
            <div class="prose prose-lg text-gray-600 max-w-none mt-5">
                <h1>Погружаемся в дженерики</h1>

<p>В <a href="/post/generics-in-php/">предыдущей статье</a> мы рассмотрели довольно скучный пример дженериков, в этой статье давайте рассмотрим примеры получше.</p>

<pre><code class="language-php">&lt;?php

$users = new Collection&lt;User&gt;();

$slugs = new Collection&lt;string&gt;();
</code></pre>

<p>Коллекции — пожалуй, самый простой способ объяснить, что такое дженерики, когда обсуждают дженерики, коллекции часто приводятся в пример.
На самом деле нередко люди думают, что "дженерики" и "коллекции с указанием типа" — одно и то же. Это определённо не так.</p>

<p>Итак, давайте рассмотрим ещё два примера.</p>

<p>Функция <code>app</code> — если вы работаете с фреймворком Laravel, она может показаться вам знакомой:
функция принимает имя класса и возвращает экземпляр этого класса, используя контейнер зависимостей:</p>

<pre><code class="language-php">&lt;?php

function app(string $className): mixed
{
    return Container::get($className);
}
</code></pre>

<p>Вам не нужно знать, как работает контейнер, важно то, что функция возвращает экземпляр класса, который вы запросили.</p>

<p>Так что, по сути, это дженериковая функция, у которой возвращаемый тип зависит от передаваемого имени класса.</p>

<p>Было бы здорово, если бы IDE и другие статические анализаторы также понимали, что при передаче функции имени класса <code>UserRepository</code>,
мы ожидаем возвращения экземпляра <code>UserRepository</code> и ничего больше:</p>

<pre><code class="language-php">&lt;?php

function app(string $className): mixed
{ /* … */ }

app(UserRepository::class); // ?
</code></pre>

<p>Дженерики позволяют нам это сделать.</p>

<p>Думаю, сейчас самое время упомянуть, что я немного слукавил: <a href="/post/generics-in-php/">ранее я говорил</a>, что в PHP дженериков не существуют, но это не совсем так.</p>

<p>Все статические анализаторы — инструменты, которые читают код, не запуская, инструменты вроде IDE — согласились использовать для дженериков Docblock-аннотацию:</p>

<pre><code class="language-php">/**
 * @template Type
 * @param class-string&lt;Type&gt; $className
 * @return Type
 */
function app(string $className): mixed
{ /* … */ }
</code></pre>

<p>Согласен, это не самый красивый синтаксис и все статические анализаторы полагаются на простое соглашение — официальной спецификации нет;
тем не менее, это работает.</p>

<p>PhpStorm, Psalm и PhpStan — три крупнейших статических анализатора в мире PHP — в той или иной степени понимают этот синтаксис.</p>

<p>IDE, такие как PhpStorm, используют его для обратной связи с программистом во время написания кода, а инструменты, такие как Psalm и PhpStan,
используют его для массового анализа вашей кодовой базы и обнаружения потенциальных ошибок, преимущественно на основе объявления типов.</p>

<p>Так что на самом деле мы можем реализовать эту функцию, чтобы наши инструменты больше не работали вслепую.</p>

<p>Непосредственно PHP не гарантирует, что возвращаемый тип будет правильным — PHP делает никаких проверок типа во время выполнения этой функции,
но если мы можем доверять нашим статическим анализаторам, то вероятность того, что этот код сломается во время выполнения, очень мала, а то и вовсе отсутствует.</p>

<p>В этом заключается невероятная сила статического анализа: мы можем быть уверены, что, не запуская код, большая его часть будет работать так, как задумано.</p>

<p>И всё это благодаря типам, включая дженерики.</p>

<p>Давайте рассмотрим более сложный пример:</p>

<pre><code class="language-php">&lt;?php

Attributes::in(MyController::class)
    -&gt;filter(RouteAttribute::class)
    -&gt;newInstance()
    -&gt;
</code></pre>

<p>У нас есть класс, который может "запрашивать" атрибуты и создавать их на лету.</p>

<p>Если вы уже работали с атрибутами, то знаете, что Reflection API довольно многословен, поэтому такой класс-помощник будет весьма полезен.</p>

<p>Как вы уже догадались, дженерики позволяют нам сделать это:</p>

<p>При использовании метода <code>filter</code>, задаётся имя класса атрибута и после вызова метода <code>newInstance</code>,
результатом будет экземпляр отфильтрованного класса. И снова, было бы неплохо, если бы наша IDE понимала, о чём мы говорим.</p>

<p>Как вы уже догадались, дженерики позволяют нам это сделать:</p>

<pre><code class="language-php">&lt;?php

/** @template AttributeType */
class Attributes
{
    /**
     * @template InputType
     * @param class-string&lt;InputType&gt; $className
     * @return self&lt;InputType&gt;
     */
    public function filter(string $className): self
    { /* … */ }

    /**
     * @return AttributeType 
     */   
    public function newInstance(): mixed
    { /* … */ }

    // …
}
</code></pre>

<p>Надеюсь, вы начинаете понимать, насколько мощной может быть простая информация о типе.
Пару лет назад мне потребовался бы плагин для IDE, чтобы подобные вещи заработали, теперь же мне просто нужно добавить информацию о типе.</p>

<p>Однако в последнем примере показаны не только на дженерики, есть ещё одна не менее важная составляющая.</p>

<p>Вывод типа: способность статического анализатора «угадывать» или надёжно определять тип без указания его пользователем.</p>

<p>Именно это происходит с аннотацией <code>class-string</code>. IDE способна распознать входные данные, которые передаются функции,
как имя класса и вывести этот тип в качестве типа с дженериком.</p>

<p>Итак, подытожим: дженерики доступны в PHP и все основные статические анализаторы знают, как с ними работать. Но... есть пара оговорок.</p>

<p>Во-первых, не существует официальной спецификации того, как должны выглядеть дженерики, прямо сейчас каждый статический анализатор может использовать свой собственный синтаксис;
на данный момент они пришли к единому соглашению, но нет никаких гарантий, что так и останется в будущем.</p>

<p>Во-вторых, Docblock-аннотации, на мой взгляд, неоптимальные. Они ощущаются как незначительная часть кодовой базы.
И да, аннотации дженериков предоставляют только статическую информацию, без проверки типов во время выполнения, но мы увидели,
насколько мощным может быть статический анализ, даже без такой проверки.</p>

<p>Я думаю, что несправедливо относиться к информации о типах как к «doc-комментариям» — они не передают важности типов в нашем коде.
Именно поэтому в PHP 8 появились атрибуты: все возможности, которые открывают атрибуты, уже были возможны с помощью Docblock-аннотаций,
но эта реализация была недостаточно хороша. То же самое относится и к дженерикам.</p>

<p>И наконец, без соответствующей спецификации у всех трёх основных статических анализаторов есть различия в реализации дженериков.
В идеале, должна быть официальная спецификация, исходящая от внутренних разработчиков PHP. Сейчас её нет.</p>

<p>Это основные причины, по которым я считаю, что стоит инвестировать время в более постоянное и устойчивое решение.</p>

<p>Так почему же в PHP до сих пор нет подходящих дженериков? Почему мы полагаемся на Docblock-аннотации без чёткой спецификации?</p>

<p>Об этом в <a href="/post/generics-why-we-cant-have-them/">следующей статье</a>.</p>
            </div>
        </div>
    </div>
</div>

<footer class="body-font bg-dark-purplish-blue">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
        <p class="text-sm text-white sm:ml-4 sm:py-2 sm:mt-0 mt-4">
            © 2022 Сергей Пантелеев
        </p>
        <div class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
            <div class="icon-list-social">
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://t.me/saundefined" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-telegram"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://vk.com/id261057243" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-vk"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://github.com/saundefined" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-github"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://twitter.com/s_panteleev" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-twitter"></i>
    </a>
</div>        </div>
    </div>
</footer>

<script src="https://plugins.jetbrains.com/assets/scripts/mp-widget.js"></script>
<script src="/assets/build/js/main.js"></script>
</body>
</html>
