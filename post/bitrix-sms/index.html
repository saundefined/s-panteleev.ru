<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>СМС-сервисы в 1С-Битрикс | Сергей Пантелеев</title>
    <meta name="description" content="Обзор СМС-сервисов в 1С-Битрикс, добавление собственного сервиса">
            <!-- Yandex.Metrika counter -->
        <script type="text/javascript"> (function (m, e, t, r, i, k, a) {
            m[i] = m[i] || function () {(m[i].a = m[i].a || []).push(arguments)}
            m[i].l = 1 * new Date()
            k = e.createElement(t), a = e.getElementsByTagName(t)[0], k.async = 1, k.src = r, a.parentNode.insertBefore(
              k, a)
          })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym')
          ym(50044507, 'init',
            { clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true }) </script>
        <noscript>
            <div><img src="https://mc.yandex.ru/watch/50044507" style="position:absolute; left:-9999px;" alt=""/></div>
        </noscript> <!-- /Yandex.Metrika counter -->
        <link rel="stylesheet" href="/assets/build/css/main.css">
</head>
<body class="flex flex-col justify-between min-h-screen font-sans antialiased">
<nav aria-labelledby="nav-heading" :aria-expanded="isOpen"
     class="container flex flex-wrap items-center justify-between py-5" x-data="{ isOpen: false }"
     @keydown.escape="isOpen = false" @click.away="isOpen = false">
    <a aria-label="logo" href="https://s-panteleev.ru">
        <span class="font-bold text-xl lg:text-lg text-dark-purplish-blue">Сергей Пантелеев</span>
    </a>

    <button :aria-expanded="isOpen" aria-controls="nav-list" aria-label="toggle menu" @click="isOpen = !isOpen"
            type="button" class="block px-2 text-indigo-900 lg:hidden focus:outline-none">
        <svg class="w-8 h-8 fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path x-show.transition="!isOpen"
                  d="M3 7h18a1 1 0 100-2H3a1 1 0 000 2zm18 10H3a1 1 0 000 2h18a1 1 0 000-2zm0-4H3a1 1 0 000 2h18a1 1 0 000-2zm0-4H3a1 1 0 000 2h18a1 1 0 000-2z"/>

            <path x-show="isOpen"
                  d="M13.41 12l6.3-6.29a1.004 1.004 0 00-1.42-1.42L12 10.59l-6.29-6.3a1.004 1.004 0 10-1.42 1.42l6.3 6.29-6.3 6.29a.999.999 0 000 1.42 1 1 0 001.42 0l6.29-6.3 6.29 6.3a1.001 1.001 0 001.639-.325 1 1 0 00-.22-1.095L13.41 12z"/>
        </svg>
    </button>

    <!--Menu-->
    <div class="flex-grow w-full lg:flex lg:items-center lg:w-auto hidden"
         :class="{ 'block': isOpen, 'hidden': !isOpen }">
        <ul id="nav-list"
            class="flex-wrap items-center justify-end flex-1 pt-6 space-y-5 lg:space-y-0 lg:pt-0 list-reset lg:flex lg:space-x-10">
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/">Главная</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/posts/">Статьи</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/projects/">Проекты</a>
            </li>
            <li>
                <a class="text-xl font-medium lg:text-lg text-dark-purplish-blue hover:text-blue-500"
                   href="https://s-panteleev.ru/about/">Обо мне</a>
            </li>
        </ul>
    </div>
</nav>
<div class="container">
        <div class="container pb-16 md:pb-28">
        <div class="pt-8 md:pt-16 pb-4 md:pb-8">
            <h1 class="font-bold xl:text-6xl lg:text-5xl md:text-4xl text-3xl text-dark-purplish-blue text-center">
                СМС-сервисы в 1С-Битрикс
            </h1>

            <div class="flex flex-row items-center my-8 space-x-1 md:space-x-4 justify-center">
                                                            <a href="/posts/tag/bitrix"
       class="bg-dark-purplish-blue text-white px-2 py-1 rounded uppercase text-sm font-bold">1С-Битрикс</a>
                                    
                <p class="font-normal text-base text-gray-600">30 декабря 2019 г.</p>
            </div>
        </div>

        <div class="h-64 md:h-96 mb-8">
            <img class="object-contain w-full h-full bg-dark-purplish-blue"
                 style="object-position: 50% 50%"
                 src="/assets/images/posts/bitrix-sms/cover.jpg"
                 alt="СМС-сервисы в 1С-Битрикс">
        </div>

        <div class="max-w-4xl">
            
            <div class="prose prose-lg text-gray-600 max-w-none mt-5">
                <p>Начиная с версии <code>18.5.0</code> в 1С-Битрикс добавлена поддержка штатной авторизации, регистрации и восстановления пароля с помощью СМС.</p>

<p>Из коробки на данный момент поддерживаются следующие сервисы: Компания SMS.RU, SMS-ассистент, Компания Twilio.com.</p>

<p>Если вы используете одну из этих компаний, обновите систему до необходимой версии,
установите модуль Служба сообщений, укажите данные для подключения к СМС-сервису в настройках <strong>Главного модуля</strong> и у вас должно появиться следующее:</p>

<p><img src="/assets/images/posts/bitrix-sms/1.png" alt="" /></p>

<h2>Добавление СМС-сервиса</h2>

<p>Для добавления собственного СМС-сервиса, начала необходимо создать класс, который будет наследовать
<code>Bitrix\MessageService\Sender\Base</code>, с обязательными методами:</p>

<table>
<thead>
<tr>
  <th>Метод</th>
  <th align="center">Возвращаемое значение</th>
  <th>Описание</th>
</tr>
</thead>
<tbody>
<tr>
  <td>getShortName()</td>
  <td align="center">string</td>
  <td>Сокращённое наименование сервиса (например, домен)</td>
</tr>
<tr>
  <td>getId()</td>
  <td align="center">string</td>
  <td>Символьный код сервиса</td>
</tr>
<tr>
  <td>getName()</td>
  <td align="center">string</td>
  <td>Полное наименование сервиса (будет выводиться во всех списках)</td>
</tr>
<tr>
  <td>canUse()</td>
  <td align="center">boolean</td>
  <td>Если <code>false</code> – сервис не будет выводиться</td>
</tr>
<tr>
  <td>getFromList()</td>
  <td align="center">array</td>
  <td>Список подтверждённых имён отправителя</td>
</tr>
<tr>
  <td>sendMessage()</td>
  <td align="center"><code>Bitrix\MessageService\Sender\Result\SendMessage</code></td>
  <td>Реализация отправки сообщения</td>
</tr>
</tbody>
</table>

<p>Примерный код для добавления собственного СМС-сервиса:</p>

<pre><code class="language-php">&lt;?php

namespace Ps\Sms\Provider;

use Bitrix\Main\Error;
use Bitrix\MessageService\Sender\Base;
use Bitrix\MessageService\Sender\Result\SendMessage;

class MyService extends Base
{
    private $login;

    private $password;

    private $client;

    public function __construct() {
        $this-&gt;login = 'login';
        $this-&gt;password = 'my_strong_password';

        $this-&gt;client = new Api($this-&gt;login, $this-&gt;password);
    }

    public function sendMessage(array $messageFields) {
        if (!$this-&gt;canUse()) {
            $result = new SendMessage();
            $result-&gt;addError(new Error('Ошибка отправки. СМС-сервис отключён'));
            return $result;
        }

        $parameters = [
            'phones' =&gt; $messageFields['MESSAGE_TO'],
            'message' =&gt; $messageFields['MESSAGE_BODY'],
        ];

        if ($messageFields['MESSAGE_FROM']) {
            $parameters['sender'] = $messageFields['MESSAGE_FROM'];
        }

        $result = new SendMessage();
        $response = $this-&gt;client-&gt;send($parameters);

        if (!$response-&gt;isSuccess()) {
            $result-&gt;addErrors($response-&gt;getErrors());
            return $result;
        }

        return $result;
    }

    public function getShortName() {
        return 'smsc.ru';
    }

    public function getId() {
        return 'smscru';
    }

    public function getName() {
        return 'SMS-центр';
    }

    public function canUse() {
        return true;
    }

    public function getFromList() {
        $data = $this-&gt;client-&gt;getSenderList();
        if ($data-&gt;isSuccess()) {
            return $data-&gt;getData();
        }

        return [];
    }
}
</code></pre>

<p>Зарегистрируйте класс в качестве обработчика события:</p>

<pre><code class="language-php">&lt;?php

$event = \Bitrix\Main\EventManager::getInstance();
$event-&gt;addEventHandler('messageservice', 'onGetSmsSenders', 'registerSmscService');

function registerSmscService() {
    return [
        // Класс СМС-сервиса
        new Ps\Sms\Provider\MyService(),
    ];
}
</code></pre>

<p>В настройках <strong>Главного модуля</strong> появится новый СМС-сервис:</p>

<p><img src="/assets/images/posts/bitrix-sms/2.png" alt="" /></p>

<h2>API</h2>

<h3>Отправка сообщения</h3>

<p>Отправка сообщения с СМС кодом подтверждения регистрации:</p>

<pre><code class="language-php">&lt;?php

$userId = 1;
$phone = \Bitrix\Main\UserPhoneAuthTable::normalizePhoneNumber('+79999999999');

\Bitrix\Main\UserPhoneAuthTable::add([
    'USER_ID' =&gt; $userId,
    'PHONE_NUMBER' =&gt; $phone,
]);

list($code, $phoneNumber) = \CUser::GeneratePhoneCode($userId);

$sms = new \Bitrix\Main\Sms\Event(
    'SMS_USER_CONFIRM_NUMBER', // SMS_USER_RESTORE_PASSWORD - для восстановления
    [
        'USER_PHONE' =&gt; $phoneNumber,
        'CODE' =&gt; $code,
    ]
);
$sms-&gt;send(true);
</code></pre>

<h3>Подтверждение номера телефона</h3>

<p>Подтверждение кода из СМС:</p>

<pre><code class="language-php">&lt;?php

$phoneRecord = \Bitrix\Main\UserPhoneAuthTable::getList([
    'filter' =&gt; [
        '=USER_ID' =&gt; 1
    ],
    'select' =&gt; ['USER_ID', 'PHONE_NUMBER', 'USER.ID', 'USER.ACTIVE'],
])-&gt;fetchObject();

if(!$phoneRecord) {
    // Ошибка. Пользователь не найден
}

$smsCode = 1111;

if(\CUser::VerifyPhoneCode($phoneRecord-&gt;getPhoneNumber(), $smsCode)) {
    if($phoneRecord-&gt;getUser()-&gt;getActive() &amp;&amp; !$USER-&gt;IsAuthorized()) {
        $USER-&gt;Authorize($userId);
    }

    return true;
}
</code></pre>

<h2>Пример</h2>

<p>Пример подключения СМС-сервисов sms16.ru, smsc.ru, mainsms.ru и некоторых других выложен на <a href="https://github.com/qq-agency/ps.sms">GitHub</a>.</p>
            </div>
        </div>
    </div>
</div>

<footer class="body-font bg-dark-purplish-blue">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
        <p class="text-sm text-white sm:ml-4 sm:py-2 sm:mt-0 mt-4">
            © 2022 Сергей Пантелеев
        </p>
        <div class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
            <div class="icon-list-social">
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://t.me/saundefined" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-telegram"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://vk.com/id261057243" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-vk"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://github.com/saundefined" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-github"></i>
    </a>
    <a class="icon-list-social-link ml-3 text-white text-opacity-70 hover:text-opacity-100 transition-all"
       href="https://twitter.com/s_panteleev" rel="noopener noreferrer" target="_blank">
        <i class="fa-brands fa-twitter"></i>
    </a>
</div>        </div>
    </div>
</footer>

<script src="https://plugins.jetbrains.com/assets/scripts/mp-widget.js"></script>
<script src="/assets/build/js/main.js"></script>
</body>
</html>
